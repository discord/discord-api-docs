<LocalePicker currentLocale="fr" />

# Cr√©ation de ta premi√®re application Discord

Les applications Discord te permettent de personnaliser et d'√©tendre tes serveurs gr√¢ce √† un ensemble d'API et de fonctions interactives. Ce guide t'aidera √† cr√©er ta premi√®re application Discord en employant JavaScript, et √† la fin, tu disposeras d'une application qui utilise des commandes slash, envoie des messages et r√©pond aux interactions avec des √©l√©ments.

Nous allons cr√©er une application Discord qui permet aux membres du serveur de jouer √† pierre-feuille-ciseaux (avec 7¬†choix au lieu des 3¬†habituels). Ce guide s'adresse aux d√©butants, mais il n√©cessite une connaissance des bases de [JavaScript](https://developer.mozilla.org/en-US/docs/Learn/Getting_started_with_the_web/JavaScript_basics).

<Collapsible title="Ce que nous allons cr√©er" icon="view">
Voici √† quoi ressemblera l'application¬†:

![D√©mo de l'exemple d'application](getting-started-demo.gif)

Voici le flux utilisateur pr√©sent√© de mani√®re un peu plus explicite¬†:

1.¬†L'utilisateur¬†1 lance une nouvelle partie et choisit son objet √† l'aide de la commande slash `/defi` de l'application.
2.¬†Un message est envoy√© dans le salon avec un bouton invitant d'autres utilisateurs √† relever le d√©fi.
3.¬†L'utilisateur¬†2 appuie sur le bouton **Accepter**.
4.¬†L'utilisateur¬†2 re√ßoit un message √©ph√©m√®re qui lui permet de s√©lectionner l'objet de son choix.
5.¬†Le r√©sultat de la partie est post√© dans le salon d'origine pour que tout le monde puisse le voir.
</Collapsible>

<Collapsible title="Ressources utilis√©es dans le cadre de ce guide" description="Vue d'ensemble des outils et technologies que nous allons utiliser" icon="list">
- **[D√©p√¥t GitHub](https://github.com/discord/discord-example-app)** o√π est stock√© le code de ce guide ainsi que d'autres exemples de code aux fonctionnalit√©s sp√©cifiques.
- **[discord-interactions](https://github.com/discord/discord-interactions-js)**, une biblioth√®que qui fournit des types et des fonctions d'assistance pour les applications Discord.
- **[Express](https://expressjs.com)**, une infrastructure Web JavaScript populaire que nous allons utiliser pour cr√©er un serveur o√π Discord peut nous envoyer les requ√™tes.
- **[Glitch](https://glitch.com/)**, un environnement en ligne qui simplifie la cr√©ation et l'h√©bergement d'applications pendant les phases initiales de prototypage et de d√©veloppement. Tu peux aussi d√©velopper en local avec un outil tel que **[ngrok](https://ngrok.com/)**.
</Collapsible>

---

## √âtape¬†1¬†: cr√©ation d'une application

Pour commencer, tu dois cr√©er une application sur le portail des d√©veloppeurs si tu ne l'as pas d√©j√† fait¬†:

<Button href="https://discord.com/developers/applications?new_application=true" color="brand">Cr√©er une appli</Button>

Saisis un nom pour ton application, puis appuie sur **Cr√©er**.

Une fois ton application cr√©√©e, tu arrives sur la page **Vue d'ensemble** de ses param√®tres, o√π tu peux mettre √† jour des informations de base relatives √† ton application, telles que sa description et son ic√¥ne. Tu y trouves √©galement l'**identifiant de l'application** et l'**URL du point de terminaison des interactions**, qui nous serviront un peu plus loin dans le guide.

### Configuration de ton bot

Maintenant, nous allons configurer l'[utilisateur bot](#DOCS_TOPICS_OAUTH2/bot-vs-user-accounts) pour ton application, ce qui lui permet d'appara√Ætre et de se comporter de fa√ßon semblable aux autres membres du serveur.

Dans l'encadr√© de gauche, clique sur **Bot**. Depuis cette page, tu peux configurer des param√®tres tels que ses [privileged intents](#DOCS_TOPICS_GATEWAY/privileged-intents) ou d√©terminer si d'autres utilisateurs peuvent l'installer.

<Collapsible title="Que sont les intents¬†?" description="Introduction aux standard intents et privileged intents" icon="question">
Les intents d√©terminent les √©v√©nements que Discord envoie √† ton application lorsque tu cr√©es une [connexion d'API Gateway](#DOCS_TOPICS_GATEWAY). Par exemple, si tu souhaites que ton application fasse quelque chose lorsque des utilisateurs ajoutent une r√©action √† un message, tu peux utiliser l'intent `GUILD_MESSAGE_REACTIONS` (`1 << 10`).

Certains intents sont [privileged](#DOCS_TOPICS_GATEWAY/privileged-intents), ce qui signifie qu'ils permettent √† ton application d'acc√©der √† des donn√©es qui peuvent √™tre consid√©r√©es comme sensibles (comme le contenu des messages). Les privileged intent sont list√©s et peuvent √™tre activ√©s ou d√©sactiv√©s sur la page **Bot** dans les param√®tres de ton application. Les standards intents, quant √† eux, ne n√©cessitent aucune permission ou configuration suppl√©mentaire.

Tu peux obtenir plus d'informations sur les intents ainsi qu'une liste compl√®te des intents disponibles, avec leurs √©v√©nements associ√©s, en consultant la [documentation de Gateway](#DOCS_TOPICS_GATEWAY/gateway-intents).
</Collapsible>

![Onglet Bot dans les param√®tres de l'application](app-add-bot.png)

Il existe √©galement une section **Token** sur la page **Bot**, qui permet de copier le token de ton bot et de le r√©initialiser si besoin.

Les tokens de bot servent √† autoriser les requ√™tes d'API et portent les permissions de ton utilisateur bot, ce qui les rend *hautement sensibles*. Tu ne dois *jamais* partager ton token ou l'inclure dans un syst√®me de contr√¥le de version.

Copie le token et garde-le dans un endroit s√ªr (par exemple, dans un gestionnaire de mots de passe).

> warn
> Tu ne pourras plus voir ton token √† moins d'en g√©n√©rer un nouveau, alors conserve-le dans un endroit s√ªr.

### Ajout de champs d'application et de permissions de bot

Les applications doivent √™tre approuv√©es par les utilisateurs qui les installent afin d'effectuer des actions dans Discord (comme la cr√©ation d'une commande slash ou la r√©cup√©ration d'une liste des membres du serveur). S√©lectionnons quelques champs d'application et permissions √† demander avant l'installation de l'application.

<Collapsible title="Que sont les champs d'application et les permissions¬†?" description="Introduction aux champs d'application et permissions de bot" icon="question">
Lors de la cr√©ation d'une application, les champs d'application et permissions d√©terminent ce que ton application peut faire et ce √† quoi elle peut acc√©der sur les serveurs Discord.

- Les [champs d'application OAuth2](#DOCS_TOPICS_OAUTH2/shared-resources-oauth2-scopes) d√©terminent les acc√®s aux donn√©es et actions que ton application peut effectuer. Elles sont accord√©es au nom de l'utilisateur qui proc√®de √† l'installation ou qui s'authentifie.
- Les [permissions](#DOCS_TOPICS_PERMISSIONS/permission-overwrites) sont les permissions granulaires pour ton utilisateur bot, les m√™mes que celles accord√©es aux autres utilisateurs dans Discord. Elles peuvent √™tre approuv√©es par l'utilisateur qui proc√®de √† l'installation ou mises √† jour ult√©rieurement dans les param√®tres du serveur ou √† l'aide d'[√©crasements de permissions](#DOCS_TOPICS_PERMISSIONS/permission-overwrites).
</Collapsible>

Clique sur **OAuth2** dans l'encadr√© de gauche, puis s√©lectionne **g√©n√©rateur d'URL**.

> info
> Le g√©n√©rateur d'URL cr√©e un lien d'installation en fonction des champs d'application et permissions que tu as s√©lectionn√©es pour ton application. Tu peux utiliser ce lien pour installer l'application sur ton propre serveur, ou le partager avec d'autres personnes pour leur permettre de l'installer.

Pour l'instant, ajoute deux champs d'application¬†:
- `applications.commands` qui permet √† ton application de g√©n√©rer des [commandes](#DOCS_INTERACTIONS_APPLICATION_COMMANDS).
- `bot` ajoute ton utilisateur bot. Une fois que tu as s√©lectionn√© `bot`, tu peux √©galement s√©lectionner diff√©rentes permissions pour ton bot. Pour l'instant, coche uniquement **Envoyer des messages**.

Tu peux consulter une liste de tous les [champs d'application OAuth2](#DOCS_TOPICS_OAUTH2/shared-resources-oauth2-scopes) ou en apprendre davantage sur les [permissions](#DOCS_TOPICS_PERMISSIONS) dans la documentation.

### Installation de ton application

Apr√®s avoir ajout√© des champs d'application, tu devrais voir appara√Ætre une URL que tu peux copier afin d'installer ton application.

![Capture d'√©cran du g√©n√©rateur d'URL](url-generator.png)

> info
> Pendant le d√©veloppement d'une application, il est conseill√© de la d√©velopper et de la tester sur un serveur qui n'est pas utilis√© par d'autres personnes. Si tu ne disposes pas d√©j√† de ton propre serveur, tu peux en [cr√©er un gratuitement](https://support.discord.com/hc/en-us/articles/204849977-How-do-I-create-a-server-).

Copie l'URL g√©n√©r√©e pr√©c√©demment, puis colle-la dans ton navigateur. Tu recevras des explications pour chaque √©tape du processus d'installation, au cours duquel tu devras v√©rifier que tu installes ton application sur un serveur qui te permettra de la d√©velopper et de la tester.

Une fois ton application install√©e, tu peux te rendre sur ton serveur pour v√©rifier qu'elle a bien √©t√© int√©gr√©e ‚ú®

Maintenant que ton application est configur√©e et install√©e, commen√ßons son d√©veloppement.

---

## √âtape¬†2¬†: ex√©cution de ton application

L'int√©gralit√© du code utilis√© dans cet exemple d'application est disponible dans [le d√©p√¥t GitHub](https://github.com/discord/discord-example-app).

Pour simplifier un peu le d√©veloppement, l'application utilise [discord-interactions](https://github.com/discord/discord-interactions-js), qui fournit des types et des fonctions d'assistance. Si tu pr√©f√®res utiliser d'autres langages ou biblioth√®ques, tu peux consulter la documentation des [ressources de la communaut√©](#DOCS_TOPICS_COMMUNITY_RESOURCES).

### Remixage du projet

Ce guide utilise Glitch, qui permet de cloner et de d√©velopper depuis ton navigateur. Si tu pr√©f√®res d√©velopper ton application en local, des instructions relatives √† l'utilisation de ngrok sont disponibles [dans le LISEZMOI](https://github.com/discord/discord-example-app#running-app-locally).

> info
> Glitch est un excellent outil de d√©veloppement et de test, mais [il pr√©sente certaines contraintes techniques](https://help.glitch.com/kb/article/17-technical-restrictions/) et il convient donc d'envisager d'autres fournisseurs d'h√©bergement pour les applications d√©j√† en production.

Pour commencer, **[remixe (ou clone) le projet Glitch üéè](https://glitch.com/edit/#!/import/git?url=https://github.com/discord/discord-example-app.git)**.

Une fois ceci fait, Glitch te redirigera vers un nouveau projet.

<Collapsible title="Interface de projet Glitch" description="Vue d'ensemble de l'interface de projet Glitch" icon="view">
![Vue d'ensemble de projet Glitch](glitch-project.png)

- Le **nom de projet** est un nom sp√©cifique √† ton projet, et se trouve dans le coin sup√©rieur gauche de l'interface.
- **`.env`** est le fichier dans lequel est stock√© l'ensemble de tes informations d'identification pour ton application.
- Les **Logs** pr√©sentent les donn√©es de sortie de ton projet, ce qui est utile pour savoir si l'application est en cours d'ex√©cution ou pour obtenir des informations sur les erreurs d√©tect√©es.
- Le bouton **Share** dans le coin sup√©rieur droit de l'interface permet d'acc√©der √† l'URL active du projet, dont tu auras besoin pour mettre en place l'interactivit√© dans la suite de ce guide.
</Collapsible>

#### Structure du projet

Tous les fichiers du projet se trouvent dans l'encadr√© de gauche de ton projet Glitch. Voici une vue d'ensemble des principaux dossiers et fichiers¬†:

```
‚îú‚îÄ‚îÄ examples    -> exemples d'applications courtes aux fonctionnalit√©s sp√©cifiques
‚îÇ   ‚îú‚îÄ‚îÄ app.js  -> code app.js termin√©
‚îÇ   ‚îú‚îÄ‚îÄ button.js
‚îÇ   ‚îú‚îÄ‚îÄ command.js
‚îÇ   ‚îú‚îÄ‚îÄ modal.js
‚îÇ   ‚îú‚îÄ‚îÄ selectMenu.js
‚îú‚îÄ‚îÄ .env        -> tes informations d'identification et identifiants
‚îú‚îÄ‚îÄ app.js      -> point d'entr√©e principal de l'application
‚îú‚îÄ‚îÄ commands.js -> payloads des commandes slash + fonctions d'assistance
‚îú‚îÄ‚îÄ game.js     -> logique sp√©cifique √† pierre-feuille-ciseaux
‚îú‚îÄ‚îÄ utils.js    -> fonctions utilitaires et √©num√©rations
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ .gitignore
```

### Ajout d'informations d'identification

Ton fichier `app.js` contient d√©j√† du code, mais tu auras besoin de ton identifiant et de ton token d'application pour effectuer des requ√™tes. Toutes tes informations d'identification peuvent √™tre stock√©es directement dans le fichier `.env`.

Tout d'abord, copie le token de l'utilisateur bot que tu as pr√©c√©demment configur√©, et copie-le dans la variable **`DISCORD_TOKEN`** de ton fichier `.env`.

Ensuite, rends-toi sur la page **Vue d'ensemble** de ton application, et copie l'**identifiant de l'application ¬´¬†APP_ID¬†¬ª** ainsi que sa **cl√© publique ¬´¬†PUBLIC_KEY¬†¬ª**. Colle-les dans les variables **`APP_ID`** et **`PUBLIC_KEY`** de ton fichier `.env`.

Maintenant que tes informations d'identification sont configur√©es, installons et g√©rons des commandes slash.

### Installation de commandes slash

> info
> Pour installer des commandes slash, l'application utilise [`node-fetch`](https://github.com/node-fetch/node-fetch). Tu peux voir l'impl√©mentation pour l'installation dans le fichier `utils.js` √† l'int√©rieur de la fonction `DiscordRequest()`.

Le projet contient un script `register` que tu peux utiliser pour installer les commandes dans la section `ALL_COMMANDS`, qui est d√©finie √† la fin du fichier `commands.js`. Il installe les commandes en tant que commandes globales en appelant le point de terminaison [`PUT /applications/<APP_ID>/commands`](#DOCS_INTERACTIONS_APPLICATION_COMMANDS/bulk-overwrite-global-application-commands) de l'API HTTP.

Si tu souhaites personnaliser les commandes ou en ajouter d'autres, tu peux consulter la structure des commandes dans la [documentation des commandes](#DOCS_INTERACTIONS_APPLICATION_COMMANDS/application-command-object-application-command-structure).

Pour ex√©cuter le script `register`, clique sur le bouton **Terminal** en bas de l'interface du projet Glitch et colle la commande suivante¬†:

```
npm run register
```

Appuie sur la touche Entr√©e pour ex√©cuter la commande.

Si tu retournes sur ton serveur, tu devrais voir appara√Ætre les commandes slash. Mais il ne se passera rien si tu essaies de les ex√©cuter, car ton application ne re√ßoit et ne traite aucune requ√™te de Discord.

<Collapsible title="Quelles sont les API de Discord¬†?" description="Vue d'ensemble des API HTTP et Gateway de Discord" icon="question">
Discord propose deux API que tu peux combiner pour cr√©er des applications¬†:

- L'**[API HTTP](#DOCS_REFERENCE/http-api)** est une API similaire √† une API REST qui permet d'effectuer des op√©rations g√©n√©rales telles que l'envoi et la mise √† jour de donn√©es dans Discord, ou la r√©cup√©ration de donn√©es relatives √† une ressource.
- L'**[API Gateway](#DOCS_REFERENCE/gateway-websocket-api)** est une API bas√©e sur WebSocket qui est utile pour maintenir l'√©tat ou suivre les √©v√©nements qui se produisent sur un serveur Discord. Nous n'utiliserons pas cette API dans ce guide, mais si tu veux en savoir plus sur la cr√©ation d'une connexion Gateway et sur les diff√©rents √©v√©nements que tu peux suivre, consulte la [documentation de Gateway](#DOCS_TOPICS_GATEWAY).
</Collapsible>

---

## √âtape¬†3¬†: gestion de l'interactivit√©

Pour permettre √† ton application de recevoir des requ√™tes de commande slash (et d'autres interactions), Discord a besoin d'une URL publique pour les envoyer. Cette URL peut √™tre configur√©e dans les param√®tres de ton application en tant qu'**URL de point de terminaison des interactions**.

### Ajout d'une URL de point de terminaison des interactions

Les projets Glitch disposent d'une URL publique expos√©e par d√©faut. Pour copier l'URL de ton projet, clique sur le bouton **Share** dans le coin sup√©rieur droit de l'interface, puis copie le lien du projet ¬´¬†Live site¬†¬ª en bas de la fen√™tre qui vient de s'ouvrir.

> info
> Si tu d√©veloppes en local, tu trouveras des instructions expliquant comment √©tablir un protocole de tunnellisation des requ√™tes vers ton environnement local [dans le LISEZMOI de GitHub](https://github.com/discord/discord-example-app#running-app-locally).

Une fois le lien copi√©, va dans les param√®tres de ton application depuis [le portail des d√©veloppeurs](https://discord.com/developers/applications).

Sur la page **Informations g√©n√©rales** de ton application, tu trouveras une option **URL de point de terminaison interactive**. Tu peux y coller l'URL de ton application suivie de `/interactions`, ce qui correspond √† l'endroit o√π l'application Express √©coute les requ√™tes.

![URL de point de terminaison des interactions dans les param√®tres de l'application](interactions-url.png)

Clique sur **Sauvegarder les modifications** et assure-toi que la v√©rification de ton point de terminaison a r√©ussi.

L'exemple d'application g√®re la v√©rification de deux fa√ßons¬†:
- Elle utilise la `PUBLIC_KEY` et le [package discord-interactions](https://github.com/discord/discord-interactions-js#usage) avec une fonction wrapper (import√©e de `utils.js`) qui la rend conforme √† l'interface `verify` d'[Express](http://expressjs.com/en/5x/api.html#express.json). Ceci est ex√©cut√© pour chaque requ√™te entrante de votre application.
- Elle r√©pond aux requ√™tes de `PING` entrantes.

Pour en savoir plus sur la pr√©paration de ton application √† la r√©ception d'interactions, consulte [la documentation sur les interactions](#DOCS_INTERACTIONS_RECEIVING_AND_RESPONDING/receiving-an-interaction).

### Gestion des requ√™tes de commandes slash

Apr√®s la v√©rification de ton point de terminaison, ouvre le fichier `app.js` de ton projet et trouve le bloc de code qui g√®re la commande `/test`¬†:

```javascript
// commande ¬´¬†test¬†¬ª
if (name === 'test') {
    // Envoi d'un message dans le salon √† partir duquel la commande a √©t√© d√©clench√©e
    return res.send({
    type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
    data: {
        // S√©lectionne un √©moji al√©atoire √† envoyer √† partir d'une fonction d'assistance
        content: 'hello world ' + getRandomEmoji(),
    },
    });
}
```

Le code ci-dessus r√©pond √† l'interaction en envoyant un message dans le salon duquel il est issu. La liste de tous les types de r√©ponses disponibles, comme une r√©ponse dans une fen√™tre, est d√©taill√©e [dans la documentation](#DOCS_INTERACTIONS_RECEIVING_AND_RESPONDING/interaction-response-object-interaction-callback-type).

> info
> `InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE` est une constante [export√©e depuis le package `discord-interactions`](https://github.com/discord/discord-interactions-js/blob/main/src/index.ts#L33).

Va sur ton serveur et v√©rifie le bon fonctionnement de la commande slash `/test` de ton application. Lorsque tu d√©clenches la commande, ton application doit t'envoyer un message contenant ¬´¬†hello world¬†¬ª accompagn√© d'un √©moji al√©atoire.

Dans la section suivante, nous allons ajouter une commande suppl√©mentaire qui utilise des options de commande slash, des boutons et des menus de s√©lection pour cr√©er le jeu pierre-feuille-ciseaux.

---

## √âtape¬†4¬†: ajout d'√©l√©ments de message

La commande `/defi` permet de lancer notre jeu pierre-feuille-ciseaux. Quand cette commande est d√©clench√©e, l'application envoie des √©l√©ments de message dans le salon, et ceux-ci guident les utilisateurs qui veulent jouer.

### Ajout d'une commande avec des options

La commande `/defi`, appel√©e `CHALLENGE_COMMAND` dans `commands.js`, dispose d'un ensemble d'`options`. Dans notre application, les options sont des objets qui repr√©sentent diff√©rentes choses qu'un utilisateur peut s√©lectionner lors d'une partie de pierre-feuille-ciseaux, et sont g√©n√©r√©es en utilisant les cl√©s `RPSChoices` dans `game.js`.

Tu peux en apprendre davantage sur les options de commande et leur structure [en consultant la documentation](#DOCS_INTERACTIONS_APPLICATION_COMMANDS/application-command-object-application-command-option-structure).

> info
> Ce guide ne traite pas en profondeur du fichier `game.js`, mais n'h√©site pas √† y jeter un coup d'≈ìil et √† modifier les commandes ou leurs options.

<Collapsible title="Gestion de l'interaction des commandes" description="Code pour g√©rer la commande defi et r√©pondre avec un message contenant un bouton" icon="code" open>

Pour g√©rer la commande `/defi`, ajoute le code suivant apr√®s le bloc if `if name === ‚Äútest‚Äù`¬†:

```javascript
// commande ¬´¬†defi¬†¬ª
if (name === 'challenge' && id) {
    const userId = req.body.member.user.id;
    // Choix d'objet de l'utilisateur
    const objectName = req.body.data.options[0].value;

    // Cr√©ation d'une partie active en utilisant l'identifiant de message comme identifiant de partie
    activeGames[id] = {
        id: userId,
        objectName,
    };

    return res.send({
    type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
    data: {
        content: `Rock papers scissors challenge from <@${userId}>`,
        components: [
        {
            type: MessageComponentTypes.ACTION_ROW,
            components: [
            {
                type: MessageComponentTypes.BUTTON,
                // Ajout de l'identifiant de partie √† utiliser ult√©rieurement
                custom_id: `accept_button_${req.body.id}`,
                label: 'Accept',
                style: ButtonStyleTypes.PRIMARY,
            },
            ],
        },
        ],
    },
    });
}
```


> info
> Si tu ne vois pas o√π coller ce code, tu peux consulter le code complet dans `examples/app.js` dans le projet Glitch ou dans le fichier `app.js` √† la racine [sur GitHub](https://github.com/discord/discord-example-app/blob/main/app.js).

Le code ci-dessus fait plusieurs choses¬†:
1.¬†Il analyse le corps de la requ√™te pour extraire l'identifiant de l'utilisateur qui a d√©clench√© la commande slash (`userId`) ainsi que l'option (choix d'objet) s√©lectionn√©e (`objectName`).
2.¬†Il ajoute un nouveau nom de partie √† l'objet `activeGames` en utilisant l'identifiant d'interaction. La partie active enregistre le `userId` et le `objectName`.
3.¬†Il renvoie un message dans le salon avec un bouton dot√© d'un `custom_id` de type `accept_button_<SOME_ID>`.

> warn
> L'exemple de code utilise un objet comme stockage en m√©moire, mais pour les applications en production, il est pr√©f√©rable d'utiliser une base de donn√©es.

Lors de l'envoi d'un message avec des [√©l√©ments de message](#DOCS_INTERACTIONS_MESSAGE_COMPONENTS/what-is-a-component), les payloads individuels sont annex√©s √† un tableau `components`. Les √©l√©ments actionnables (tels que les boutons) doivent √™tre inclus dans une [ligne d'action](#DOCS_INTERACTIONS_MESSAGE_COMPONENTS/action-rows), que tu peux voir dans l'exemple de code.

Observe le `custom_id` unique envoy√© avec les √©l√©ments de message, ici `accept_button_` avec l'identifiant de partie active en annexe. Un `custom_id` peut √™tre utilis√© pour g√©rer les requ√™tes que Discord t'envoie lorsque quelqu'un interagit avec l'√©l√©ment, ce que tu verras dans un moment.

D√©sormais, lorsque tu ex√©cutes la commande `/defi` et s√©lectionnes une option, ton application envoie un message avec un bouton **Accepter**. Ajoutons du code pour g√©rer le clic sur le bouton.

</Collapsible>

<Collapsible title="Gestion des interactions avec les boutons" description="Code pour g√©rer les clics sur les boutons et r√©pondre avec un message √©ph√©m√®re" icon="code" open>

Lorsque des utilisateurs interagissent avec un √©l√©ment de message, Discord envoie une requ√™te avec un [type d'interaction](#DOCS_INTERACTIONS_RECEIVING_AND_RESPONDING/interaction-object-interaction-type) √©gal √† `3` (ou la valeur `MESSAGE_COMPONENT` lors de l'utilisation de `discord-interactions`).

Pour mettre en place un gestionnaire pour le bouton, nous allons v√©rifier le `type` d'interaction, puis le `custom_id`.

Colle le code suivant sous le gestionnaire de type pour `APPLICATION_COMMAND`¬†:

```javascript
if (type === InteractionType.MESSAGE_COMPONENT) {
// custom_id d√©fini dans le payload lors de l'envoi de l'√©l√©ment de message
const componentId = data.custom_id;

  if (componentId.startsWith('accept_button_')) {
    // r√©cup√©ration de l'identifiant de partie associ√©
    const gameId = componentId.replace('accept_button_', '');
    // Suppression du message avec le token dans le corps de la requ√™te
    const endpoint = `webhooks/${process.env.APP_ID}/${req.body.token}/messages/${req.body.message.id}`;
    try {
      await res.send({
        type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
        data: {
          // S√©lectionne un √©moji al√©atoire √† envoyer √† partir d'une fonction d'assistance
          content: 'What is your object of choice?',
          // Indique qu'il s'agit d'un message √©ph√©m√®re
          flags: InteractionResponseFlags.EPHEMERAL,
          components: [
            {
              type: MessageComponentTypes.ACTION_ROW,
              components: [
                {
                  type: MessageComponentTypes.STRING_SELECT,
                  // Annexe l'identifiant de partie
                  custom_id: `select_choice_${gameId}`,
                  options: getShuffledOptions(),
                },
              ],
            },
          ],
        },
      });
      // Suppression du message pr√©c√©dent
      await DiscordRequest(endpoint, { method: 'DELETE' });
    } catch (err) {
      console.error('Error sending message:', err);
    }
  }
}
```

Le code ci-dessus¬†:
1.¬†V√©rifie qu'il existe un identifiant personnalis√© `custom_id` correspondant √† ce que nous avons envoy√© pr√©c√©demment (ici, il commence par `accept_button_`). L'identifiant personnalis√© comprend √©galement l'identifiant de partie active en annexe, donc nous le stockons dans `gameID`.
2.¬†[Supprime le message d'origine](#DOCS_INTERACTIONS_RECEIVING_AND_RESPONDING/delete-original-interaction-response) en appelant un webhook avec `node-fetch` et en passant le `token` d'interaction unique dans le corps de la requ√™te. Cette op√©ration permet de nettoyer le salon pour √©viter que d'autres utilisateurs ne cliquent sur le bouton.
3.¬†R√©pond √† la requ√™te en envoyant un message contenant un menu de s√©lection avec les choix d'objets pour le jeu. Le payload devrait √™tre assez similaire au pr√©c√©dent, √† l'exception du tableau `options` et du `flags: 64`, [qui indique que le message est √©ph√©m√®re](#DOCS_INTERACTIONS_RECEIVING_AND_RESPONDING/create-followup-message).

Le tableau `options` est peupl√© en utilisant la m√©thode `getShuffledOptions()` dans `game.js`, qui manipule les valeurs `RPSChoices` pour √™tre conforme au format des [options des √©l√©ments de message](#DOCS_INTERACTIONS_MESSAGE_COMPONENTS/select-menu-object-select-option-structure).

</Collapsible>

<Collapsible title="Gestion des interactions avec le menu de s√©lection" description="Code pour r√©pondre aux interactions avec le menu de s√©lection et mettre √† jour l'√©tat de la partie" icon="code" open>

La derni√®re chose √† ajouter est le code permettant de g√©rer les interactions avec le menu de s√©lection et d'envoyer le r√©sultat de la partie dans le salon.

Comme les menus de s√©lection sont √©galement des √©l√©ments de message, le code qui g√®re leurs interactions est presque identique au code des boutons.

Modifie le code ci-dessus pour g√©rer le menu de s√©lection¬†:

```javascript
if (type === InteractionType.MESSAGE_COMPONENT) {
// custom_id d√©fini dans le payload lors de l'envoi de l'√©l√©ment de message
const componentId = data.custom_id;

  if (componentId.startsWith('accept_button_')) {
    // r√©cup√©ration de l'identifiant de partie associ√©
    const gameId = componentId.replace('accept_button_', '');
    // Suppression du message avec le token dans le corps de la requ√™te
    const endpoint = `webhooks/${process.env.APP_ID}/${req.body.token}/messages/${req.body.message.id}`;
    try {
      await res.send({
        type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
        data: {
          // S√©lectionne un √©moji al√©atoire √† envoyer √† partir d'une fonction d'assistance
          content: 'What is your object of choice?',
          // Indique qu'il s'agit d'un message √©ph√©m√®re
          flags: InteractionResponseFlags.EPHEMERAL,
          components: [
            {
              type: MessageComponentTypes.ACTION_ROW,
              components: [
                {
                  type: MessageComponentTypes.STRING_SELECT,
                  // Annexe l'identifiant de partie
                  custom_id: `select_choice_${gameId}`,
                  options: getShuffledOptions(),
                },
              ],
            },
          ],
        },
      });
      // Suppression du message pr√©c√©dent
      await DiscordRequest(endpoint, { method: 'DELETE' });
    } catch (err) {
      console.error('Error sending message:', err);
    }
  } else if (componentId.startsWith('select_choice_')) {
    // r√©cup√©ration de l'identifiant de partie associ√©
    const gameId = componentId.replace('select_choice_', '');

    if (activeGames[gameId]) {
      // Obtention de l'identifiant d'utilisateur et du choix d'objet de l'utilisateur qui r√©pond
      const userId = req.body.member.user.id;
      const objectName = data.values[0];
      // Calcul du r√©sultat √† l'aide d'une fonction d'assistance
      const resultStr = getResult(activeGames[gameId], {
        id: userId,
        objectName,
      });

      // Suppression de la partie du stockage
      delete activeGames[gameId];
      // Mise √† jour du message avec le token dans le corps de la requ√™te
      const endpoint = `webhooks/${process.env.APP_ID}/${req.body.token}/messages/${req.body.message.id}`;

      try {
        // Envoi des r√©sultats
        await res.send({
          type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
          data: { content: resultStr },
        });
        // Mise √† jour du message √©ph√©m√®re
        await DiscordRequest(endpoint, {
          method: 'PATCH',
          body: {
            content: 'Nice choice ' + getRandomEmoji(),
            components: []
          }
        });
      } catch (err) {
        console.error('Error sending message:', err);
      }
    }
  }
}
```

Comme le code pr√©c√©dent, le code ci-dessus obtient l'identifiant de l'utilisateur et sa s√©lection d'objet √† partir de la demande d'interaction.

Ces informations, ainsi que l'identifiant et la s√©lection de l'utilisateur d'origine stock√©s dans l'objet `activeGames`, sont transmises √† la fonction `getResult()`. `getResult()` d√©termine le vainqueur, puis cr√©e une cha√Æne lisible √† renvoyer dans le salon.

Nous appelons √©galement un autre webhook, cette fois-ci pour [mettre √† jour le message √©ph√©m√®re de suivi](#DOCS_INTERACTIONS_RECEIVING_AND_RESPONDING/edit-followup-message) puisqu'il ne peut pas √™tre supprim√©.

Enfin, les r√©sultats sont envoy√©s dans le salon en utilisant le type de r√©ponse d'interaction `CHANNEL_MESSAGE_WITH_SOURCE`.

</Collapsible>

‚Ä¶ et voil√† üéä Il ne te reste plus qu'√† tester ton application pour v√©rifier que tout fonctionne.

---

## √âtapes suivantes

F√©licitations, tu viens de cr√©er ta premi√®re application Discord¬†! ü§ñ

Nous esp√©rons que tu en sais maintenant un peu plus sur les applications Discord, leur configuration et la mani√®re de les rendre interactives. Tu peux d√©sormais poursuivre le d√©veloppement de ton application ou explorer les autres possibilit√©s qui s'offrent √† toi¬†:
- Lire **[la documentation](#DOCS_INTRO)** pour en savoir plus sur les fonctionnalit√©s des API
- Parcourir le dossier `examples/` de ce projet pour y trouver des exemples de code courts aux fonctionnalit√©s sp√©cifiques
- Explorer les **[ressources de la communaut√©](#DOCS_TOPICS_COMMUNITY_RESOURCES)** pour d√©couvrir des outils sp√©cifiques √† un langage maintenus par les membres de la communaut√©
- Lire notre tutoriel sur [l'h√©bergement d'applications Discord sur Cloudflare Workers](#DOCS_TUTORIALS_HOSTING_ON_CLOUDFLARE_WORKERS)
- Rejoindre le **[serveur Discord Developers](https://discord.gg/discord-developers)** pour poser des questions sur les API, participer √† des √©v√©nements organis√©s par l'√©quipe API de Discord, et interagir avec d'autres d√©veloppeurs
